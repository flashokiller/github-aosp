name: test

on: 
  push:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-18.04

    steps:
    - name: Checkout
      uses: actions/checkout@v1
      

        
    - name: Sync 
      run: |
        export CCACHE_COMPRESS=1
        export USE_CCACHE=1
        git config --global user.name "adrian-8901"
        git config --global user.email "adrianlam230@gmail.com"
        mkdir ~/fluid
        cd ~/fluid
        sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
        mkdir ~/bin
        PATH=~/bin:$PATH
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        repo init --depth=1 --no-repo-verify -u https://github.com/Project-Fluid/manifest.git -b fluid-11 -g default,-device,-mips,-darwin,-notdefault
        git clone https://github.com/adrian-8901/.repo-local_manifest.git --depth 1  .repo/local_manifests
        repo sync  -j128 --force-sync --current-branch --no-tags --no-clone-bundle --optimized-fetch --prune
        
    - name: Build 
      run: |
        cd ~/fluid
        source build/envsetup.sh
        lunch fluid_umi-eng
        export WITH_GAPPS=true
        export SELINUX_IGNORE_NEVERALLOWS=true
        export TZ=Asia/Hong_Kong
        mka bacon -j24
    - name: Upload
      run: |
        cd ~/fluid
        curl --upload-file out/target/product/umi/*.zip https://transfer.sh
        rm -rf out/target/product/umi/*.zip
